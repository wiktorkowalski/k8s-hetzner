authentik:
  # SECURITY: Values loaded from SealedSecret (see manifests/sealed-secret.yaml.example)
  # After creating the SealedSecret, uncomment these to use existing secret:
  # secret_key:
  #   secretKeyRef:
  #     name: authentik-secrets
  #     key: secret-key

  # Temporary placeholder - REPLACE BEFORE PRODUCTION
  secret_key: "TEMP-REPLACE-ME-WITH-SEALEDSECRET"
  error_reporting:
    enabled: false
  postgresql:
    host: "authentik-postgres-rw"
    name: "authentik"
    user: "authentik"
    # Load from SealedSecret after creation:
    # password:
    #   secretKeyRef:
    #     name: authentik-secrets
    #     key: db-password

    # Temporary placeholder - REPLACE BEFORE PRODUCTION
    password: "TEMP-REPLACE-ME-WITH-SEALEDSECRET"

server:
  replicas: 1

  # Health checks
  livenessProbe:
    httpGet:
      path: /-/health/live/
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /-/health/ready/
      port: http
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault

  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 1000
    capabilities:
      drop:
        - ALL

  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  ingress:
    enabled: true
    ingressClassName: traefik
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - auth.k8s.vicio.ovh
    tls:
      - secretName: authentik-tls
        hosts:
          - auth.k8s.vicio.ovh

worker:
  replicas: 1

  # Health checks (worker uses celery)
  livenessProbe:
    exec:
      command:
        - ak
        - healthcheck
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    exec:
      command:
        - ak
        - healthcheck
    initialDelaySeconds: 20
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3

  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault

  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 1000
    capabilities:
      drop:
        - ALL

  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

# Use external PostgreSQL (CNPG)
postgresql:
  enabled: false

# Redis configuration
redis:
  enabled: true
  auth:
    enabled: false

  master:
    persistence:
      enabled: true
      storageClass: longhorn
      size: 2Gi

    livenessProbe:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 5

    readinessProbe:
      enabled: true
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 5

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

    securityContext:
      enabled: true
      runAsNonRoot: true
      runAsUser: 1001
      fsGroup: 1001

    containerSecurityContext:
      enabled: true
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      runAsUser: 1001
      capabilities:
        drop:
          - ALL
