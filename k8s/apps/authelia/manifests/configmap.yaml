apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-config
  namespace: authelia
data:
  configuration.yml: |
    ---
    theme: auto
    jwt_secret: CHANGEME_JWT_SECRET_AT_LEAST_32_CHARS  # CHANGE THIS!
    default_redirection_url: https://auth.k8s.k8s.vicio.ovh  # UPDATE THIS

    server:
      host: 0.0.0.0
      port: 9091

    log:
      level: info

    totp:
      issuer: k8s.k8s.vicio.ovh  # UPDATE THIS
      period: 30
      skew: 1

    authentication_backend:
      file:
        path: /config/users_database.yml
        password:
          algorithm: argon2id
          iterations: 1
          salt_length: 16
          parallelism: 8
          memory: 64

    access_control:
      default_policy: deny
      rules:
        # Allow access to Authelia portal
        - domain: auth.k8s.k8s.vicio.ovh  # UPDATE THIS
          policy: bypass

        # Public resources (bypass auth)
        # - domain: "*.k8s.k8s.vicio.ovh"
        #   resources:
        #     - "^/api/public.*$"
        #   policy: bypass

        # Require one-factor auth (username + password)
        - domain: "*.k8s.k8s.vicio.ovh"  # UPDATE THIS
          policy: one_factor

        # Require two-factor auth (username + password + TOTP)
        # - domain: "admin.k8s.k8s.vicio.ovh"  # UPDATE THIS
        #   policy: two_factor

    session:
      name: authelia_session
      secret: CHANGEME_SESSION_SECRET_AT_LEAST_32_CHARS  # CHANGE THIS!
      expiration: 1h
      inactivity: 5m
      domain: k8s.k8s.vicio.ovh  # UPDATE THIS (use root domain)

      redis:
        host: authelia-redis
        port: 6379

    regulation:
      max_retries: 3
      find_time: 2m
      ban_time: 5m

    storage:
      encryption_key: CHANGEME_STORAGE_ENCRYPTION_KEY_32_CHARS  # CHANGE THIS!
      local:
        path: /data/db.sqlite3

    notifier:
      disable_startup_check: true
      filesystem:
        filename: /data/notification.txt
      # For production, use SMTP:
      # smtp:
      #   host: smtp.gmail.com
      #   port: 587
      #   username: your-email@gmail.com
      #   password: your-app-password
      #   sender: authelia@vicio.ovh
      #   subject: "[Authelia] {title}"

  users_database.yml: |
    ---
    users:
      # Default user: admin / changeme
      # Generate a password hash:
      # docker run --rm authelia/authelia:latest authelia crypto hash generate argon2 --password 'yourpassword'
      admin:
        disabled: false
        displayname: "Admin User"
        password: "$argon2id$v=19$m=65536,t=3,p=4$BpLfGoB+qwg+j7i3Q3fmPA$DqSixyLMxm7v2kEbHRIGgpJdpswqe2J9hJSdOIDkGNw"  # changeme
        email: admin@k8s.k8s.vicio.ovh  # UPDATE THIS
        groups:
          - admins
          - dev
